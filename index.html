<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Continue to amazon</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z9XWBVX34H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z9XWBVX34H');

    function getRedditSubreddit() {
      const ref = document.referrer || "";
      const match = ref.match(/https?:\/\/(www\.|old\.)?reddit\.com\/r\/([^\/?#]+)/i);
      return match ? match[2].toLowerCase() : null;
    }

    (function trackRedditReferrer() {
      if (typeof gtag !== "function") return;
      const subreddit = getRedditSubreddit();
      if (!subreddit) return;
      gtag("event", "reddit_referrer", {
        subreddit: subreddit,
        referrer: document.referrer
      });
      gtag("set", "user_properties", { reddit_subreddit: subreddit });
    })();
  </script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@500;600;700&family=DM+Sans:wght@400;500;600&display=swap");

    :root {
      --ink: #1d1d1f;
      --muted: #5d616b;
      --accent: #f25c44;
      --accent-dark: #cc4a37;
      --accent-soft: #ffe8e2;
      --teal: #0f6b6a;
      --card: #ffffff;
      --surface: #fff7f2;
      --outline: rgba(242, 92, 68, 0.18);
      --shadow: 0 22px 50px rgba(36, 24, 18, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "DM Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      padding: 28px 16px;
      text-align: center;
      background: radial-gradient(1200px 600px at 10% -10%, #ffe0cc 0%, transparent 60%),
        radial-gradient(900px 700px at 110% 10%, #d5f1ef 0%, transparent 65%),
        linear-gradient(130deg, #fff4eb 0%, #f8fbff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--ink);
      position: relative;
      overflow: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      filter: blur(10px);
      opacity: 0.6;
      z-index: 0;
    }

    body::before {
      top: -130px;
      left: -90px;
      background: #ffd2be;
    }

    body::after {
      bottom: -140px;
      right: -120px;
      background: #ccebe8;
    }
    
    .container {
      max-width: 520px;
      width: 100%;
      background: var(--card);
      padding: 32px 30px 34px;
      border-radius: 22px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(242, 92, 68, 0.12);
      position: relative;
      z-index: 1;
      text-align: left;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 22px;
    }

    .brand {
      font-family: "Bricolage Grotesque", "DM Sans", sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
      letter-spacing: 0.2px;
    }

    .pill {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid rgba(15, 107, 106, 0.2);
      color: var(--teal);
      font-weight: 600;
    }
    
    h2 {
      font-family: "Bricolage Grotesque", "DM Sans", sans-serif;
      font-size: 30px;
      margin-bottom: 12px;
      font-weight: 700;
      color: var(--ink);
    }
    
    p {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 18px;
      line-height: 1.5;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--accent-soft);
      color: var(--accent-dark);
      border: 1px solid var(--outline);
      margin-bottom: 12px;
      font-weight: 600;
      width: fit-content;
    }

    
    .btn {
      font-size: 18px;
      padding: 16px 32px;
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 14px 28px rgba(242, 92, 68, 0.22);
      margin: 6px 0 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(242, 92, 68, 0.26);
    }
    
    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }

    .btn.secondary {
      background: transparent;
      color: var(--accent-dark);
      border: 1px solid rgba(242, 92, 68, 0.3);
      box-shadow: none;
    }

    .btn.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed rgba(93, 97, 107, 0.4);
      box-shadow: none;
    }
    
    .brand-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .debug {
      display: none;
      margin-top: 20px;
      word-break: break-all;
      font-size: 12px;
      padding: 12px;
      background: rgba(242, 92, 68, 0.08);
      border-radius: 8px;
      color: var(--muted);
      border: 1px solid rgba(242, 92, 68, 0.15);
    }

    .debug.is-visible {
      display: block;
    }
    
    .tip {
      margin-top: 16px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(242, 92, 68, 0.12);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    @media (max-width: 520px) {
      .container {
        padding: 28px 22px 30px;
      }

      h2 {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand-wrap">
        <div class="brand">ShopIt</div>
      </div>
      <div class="pill">Retail handoff</div>
    </div>
    <div class="badge">
      <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M17 10h-1V8a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V8Z" fill="currentColor"/>
      </svg>
      Secure handoff
    </div>
    <h2 id="title">Continue to amazon</h2>
    <p id="message">Tap to check this item on Amazon.</p>
    <button class="btn" id="btnBrowser">Continue to amazon</button>
    <div class="note">We don't store your clicks. This just opens the destination.</div>
    <div class="tip" id="tip">Tip: If you stay inside Reddit, use the menu to open in your browser.</div>
    <small class="debug" id="dbg"></small>
  </div>
  <noscript>
    <p style="color:#fff; text-align:center; margin-top:20px;">
      JavaScript is required. Use this link:
      <a href="https://www.amazon.com/" style="color:#fff; text-decoration:underline;">Open Amazon</a>
    </p>
  </noscript>

  <script>
    // Get URL parameter
    const params = new URLSearchParams(location.search);
    const rawUrlParam = params.get("url");
    const rawQuery = (location.search || "").replace(/^\?/, "");

    function getRawUrlFromQueryRemainder() {
      const search = location.search || "";
      const marker = "url=";
      const idx = search.indexOf(marker);
      if (idx === -1) return null;
      let tail = search.slice(idx + marker.length);
      const hashIdx = tail.indexOf("#");
      if (hashIdx !== -1) tail = tail.slice(0, hashIdx);
      const debugIdx = tail.indexOf("&debug=");
      if (debugIdx !== -1) tail = tail.slice(0, debugIdx);
      return decodeURIComponent(tail.replace(/\+/g, "%20"));
    }

    function extractSearchQuery() {
      if (rawUrlParam) return null;
      if (!rawQuery) return null;

      if (params.has("q")) return params.get("q");
      if (params.has("k")) return params.get("k");
      if (params.has("query")) return params.get("query");

      let cleaned = rawQuery.replace(/(^|&)debug=1(&|$)/, "$1").replace(/^&|&$/g, "");
      if (!cleaned || cleaned.includes("=")) return null;
      return decodeURIComponent(cleaned.replace(/\+/g, "%20"));
    }

    const searchQuery = extractSearchQuery();
    let rawUrl = rawUrlParam;
    if (rawUrlParam && params.size > 1) {
      const remainder = getRawUrlFromQueryRemainder();
      if (remainder && /^https?:\/\//i.test(remainder)) {
        rawUrl = remainder;
      }
    }
    
    const AFFILIATE_REF = "as_li_ss_tl";
    const DEFAULT_COUNTRY = "US";
    const STORE_BY_COUNTRY = {
      US: { root: "amazon.com", tag: "bestdeals202f-20", language: "en_US" },
      GB: { root: "amazon.co.uk", tag: "bestdeals0d6c-21", language: "en_GB" },
      DE: { root: "amazon.de", tag: "bestdeals05ab-21", language: "de_DE" },
      CA: { root: "amazon.ca", tag: "bestdeal06b4d-20", language: "en_CA" },
      ES: { root: "amazon.es", tag: "bestdeals01da-21", language: "es_ES" }
    };
    const COUNTRY_ALIASES = { UK: "GB" };
    const GEO_API_URL = "https://ipapi.co/json/";
    const GEO_TIMEOUT_MS = 1400;
    
    // Allowed Amazon domains (root domains; subdomains allowed)
    const allowedRoots = [
      "amazon.com",
      "amazon.co.uk",
      "amazon.de",
      "amazon.fr",
      "amazon.it",
      "amazon.es",
      "amazon.ca",
      "amazon.com.mx",
      "amazon.com.br",
      "amazon.in",
      "amazon.cn",
      "amazon.co.jp",
      "amazon.com.au"
    ];
    const allowedExact = new Set(["amzn.to"]);

    function resolveCountry(code) {
      const normalized = (code || "").toUpperCase();
      const aliased = COUNTRY_ALIASES[normalized] || normalized;
      if (STORE_BY_COUNTRY[aliased]) {
        return aliased;
      }
      return DEFAULT_COUNTRY;
    }

    function getStore(code) {
      return STORE_BY_COUNTRY[resolveCountry(code)];
    }

    function buildStoreHome(store) {
      return `https://www.${store.root}/?tag=${store.tag}&ref=${AFFILIATE_REF}`;
    }

    function buildStoreSearch(store, query) {
      const url = new URL(`https://www.${store.root}/s`);
      url.searchParams.set("k", query);
      if (store.language) {
        url.searchParams.set("language", store.language);
      }
      url.searchParams.set("tag", store.tag);
      url.searchParams.set("ref", AFFILIATE_REF);
      return url.toString();
    }

    function isAllowedHost(hostname) {
      const host = hostname.toLowerCase();
      if (allowedExact.has(host)) return true;
      return allowedRoots.some(root => host === root || host.endsWith(`.${root}`));
    }

    function extractSubdomain(hostname) {
      for (const root of allowedRoots) {
        if (hostname === root) return "";
        if (hostname.endsWith(`.${root}`)) {
          return hostname.slice(0, hostname.length - root.length - 1);
        }
      }
      return null;
    }

    function applyStoreRoot(url, storeRoot) {
      const host = url.hostname.toLowerCase();
      const subdomain = extractSubdomain(host);
      if (subdomain === null) return;
      url.hostname = subdomain ? `${subdomain}.${storeRoot}` : storeRoot;
    }

    async function detectCountryCode() {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), GEO_TIMEOUT_MS);

      try {
        const response = await fetch(GEO_API_URL, {
          signal: controller.signal,
          cache: "no-store"
        });
        if (!response.ok) return null;
        const data = await response.json();
        return data && (data.country_code || data.country);
      } catch (err) {
        return null;
      } finally {
        clearTimeout(timeout);
      }
    }

    // Validate and normalize URL
    let target = buildStoreHome(getStore(DEFAULT_COUNTRY));
    let resolvedCountry = DEFAULT_COUNTRY;

    function buildTargetForStore(store) {
      let nextTarget = buildStoreHome(store);
      try {
        if (rawUrl) {
          const url = new URL(rawUrl);
          if (url.protocol !== "http:" && url.protocol !== "https:") {
            throw new Error("Invalid protocol");
          }
          if (!isAllowedHost(url.hostname)) {
            throw new Error("Host not allowed");
          }
          if (url.hostname.toLowerCase() !== "amzn.to") {
            applyStoreRoot(url, store.root);
            url.searchParams.set("tag", store.tag);
            url.searchParams.set("ref", AFFILIATE_REF);
          }
          nextTarget = url.toString();
        } else if (searchQuery) {
          nextTarget = buildStoreSearch(store, searchQuery);
        }
      } catch (e) {
        console.error("URL parsing error:", e);
        nextTarget = buildStoreHome(getStore(DEFAULT_COUNTRY));
      }
      return nextTarget;
    }
    
    // Device detection
    const ua = navigator.userAgent || "";
    const isAndroid = /android/i.test(ua);
    const isIOS = /iphone|ipad|ipod/i.test(ua);
    const isMobile = isAndroid || isIOS;
    
    // Get DOM elements
    const btnBrowser = document.getElementById("btnBrowser");
    const dbg = document.getElementById("dbg");
    const title = document.getElementById("title");
    const message = document.getElementById("message");
    const tip = document.getElementById("tip");
    
    // Display info
    function updateDebug() {
      if (params.get("debug") !== "1") return;
      dbg.textContent = `country=${resolvedCountry}\nstore=${getStore(resolvedCountry).root}\ntarget=${target}`;
      dbg.classList.add("is-visible");
    }

    function setButtonReady() {
      btnBrowser.disabled = false;
      btnBrowser.textContent = "Continue to amazon";
      message.textContent = "Tap to check this item on Amazon.";
    }

    async function initGeoTarget() {
      btnBrowser.disabled = true;
      btnBrowser.textContent = "Checking your location...";
      message.textContent = "Detecting your region to open the right Amazon store.";

      try {
        const detected = await detectCountryCode();
        resolvedCountry = resolveCountry(detected);
      } catch (err) {
        resolvedCountry = DEFAULT_COUNTRY;
      }

      const store = getStore(resolvedCountry);
      target = buildTargetForStore(store);
      updateDebug();
      setButtonReady();
    }

    initGeoTarget();

    if (isIOS) {
      tip.textContent = "Tip: Tap the share icon and choose “Open in Safari”.";
    } else if (isAndroid) {
      tip.textContent = "Tip: If Amazon opens the app, you can change “Open by default” in Android settings.";
    } else {
      tip.textContent = "Tip: If a popup is blocked, allow it for this page.";
    }
    
    // Open in external browser
    function openInBrowser() {
      if (isAndroid) {
        // Android: open default external browser (avoid in-app webview)
        const url = new URL(target);
        const intent = `intent://${url.host}${url.pathname}${url.search}#Intent;scheme=${url.protocol.replace(":", "")};action=android.intent.action.VIEW;category=android.intent.category.BROWSABLE;S.browser_fallback_url=${encodeURIComponent(target)};end`;

        title.textContent = "Opening your browser…";
        message.textContent = "If it stays in Reddit, tap ⋮ and choose “Open in browser”.";

        // Try intent in a new tab first; then fall back to intent navigation.
        const opened = window.open(intent, "_blank", "noopener");
        if (!opened) {
          window.location.href = intent;
        }

        // If still visible, try a direct new-tab open as a last resort.
        setTimeout(() => {
          if (document.visibilityState === "visible") {
            window.open(target, "_blank", "noopener");
          }
        }, 800);
      } else if (isIOS) {
        // iOS: cannot force external Safari from in-app browsers
        title.textContent = "Open in Safari";
        message.textContent = "Tap the share icon and choose “Open in Safari” if it stays in Reddit.";
        window.location.href = target;
        
      } else {
        // Desktop
        title.textContent = "Opening Amazon…";
        message.textContent = "Opening in your browser.";
        window.location.href = target;
      }
    }

    // Button click handler
    btnBrowser.addEventListener("click", function (e) {
      e.preventDefault();

      const go = () => openInBrowser();
      let fired = false;

      try {
        if (typeof gtag === "function") {
          gtag("event", "click_continue_amazon", {
            event_category: "engagement",
            event_label: "check_on_amazon",
            value: 1,
            transport_type: "beacon",
            event_callback: function () {
              if (!fired) {
                fired = true;
                go();
              }
            }
          });

          setTimeout(function () {
            if (!fired) {
              fired = true;
              go();
            }
          }, 250);

          return;
        }
      } catch (err) {
        console.warn("gtag event failed:", err);
      }

      go();
    });
  </script>
</body>
</html>
